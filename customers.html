<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>EMI Dealer — Customer List (SweetAlert2)</title>

  <!-- Replace with your firebase config -->
  <script type="module">
    window.firebaseConfig = {
      apiKey: "AIzaSyDxpLuWeigl_jOw-6lB4_0Zqdr_X5mEc3I",
    authDomain: "kspecialtool.firebaseapp.com",
    databaseURL: "https://kspecialtool-default-rtdb.firebaseio.com",
    projectId: "kspecialtool",
    storageBucket: "kspecialtool.appspot.com",
    messagingSenderId: "101775819923",
    appId: "1:101775819923:web:58aeca55fd62104d1cf966",
    measurementId: "G-B8E7Z6L19S"
    };
  </script>

  <!-- SweetAlert2 CSS -->
  <link href="https://cdn.jsdelivr.net/npm/sweetalert2@11/dist/sweetalert2.min.css" rel="stylesheet">

  <style>
    :root{
      --bg:#08103a;
      --panel:#0f1a4a;
      --primary:#1A237E;
      --accent:#536dfe;
      --muted:#cfd9ff;
      --glass: rgba(255,255,255,0.03);
      --success:#00e676;
      --danger:#ff5252;
      --radius:12px;
    }
    *{box-sizing:border-box}
    body{margin:0;font-family:Inter, system-ui, -apple-system, 'Segoe UI', Roboto, Arial;background:linear-gradient(180deg,var(--bg),#051033);color:#eaf0ff;min-height:100vh;padding:26px}
    .container{max-width:1200px;margin:0 auto}
    .header{display:flex;align-items:center;justify-content:space-between;gap:16px;margin-bottom:18px;flex-wrap:wrap}
    .brand{display:flex;gap:12px;align-items:center}
    .logo{width:62px;height:62px;border-radius:12px;background:linear-gradient(135deg,var(--primary),#3f51b5);display:flex;align-items:center;justify-content:center;font-weight:800;font-size:20px;box-shadow:0 10px 30px rgba(2,6,23,0.5)}
    .brand-text .title{font-size:18px;font-weight:700}
    .brand-text .subtitle{font-size:13px;color:var(--muted)}

    .controls{display:flex;gap:10px;align-items:center;flex-wrap:wrap}
    .search{padding:10px 14px;border-radius:12px;background:var(--glass);border:1px solid rgba(255,255,255,0.03);min-width:220px;color:inherit}
    .select{padding:10px 12px;border-radius:12px;background:transparent;border:1px solid rgba(255,255,255,0.05);color:inherit}
    .btn{padding:10px 14px;border-radius:12px;border:none;background:linear-gradient(90deg,var(--accent),#7c3aed);color:#071022;font-weight:700;cursor:pointer}

    .meta-row{display:flex;justify-content:space-between;align-items:center;margin-bottom:10px;color:var(--muted);font-size:13px}
    .grid{display:grid;grid-template-columns:repeat(3,1fr);gap:14px}
    @media (max-width:980px){.grid{grid-template-columns:repeat(2,1fr)}}
    @media (max-width:640px){.grid{grid-template-columns:1fr}}

    .card{background:linear-gradient(180deg, rgba(255,255,255,0.02), rgba(255,255,255,0.01));padding:14px;border-radius:12px;box-shadow:0 8px 30px rgba(2,6,23,0.6);border:1px solid rgba(255,255,255,0.03);cursor:pointer;transition:transform .16s ease,box-shadow .16s ease}
    .card:hover{transform:translateY(-6px);box-shadow:0 18px 40px rgba(2,6,23,0.7)}
    .card-head{display:flex;align-items:center;gap:12px}
    .avatar{width:52px;height:52px;border-radius:10px;background:linear-gradient(135deg,var(--primary),#2b3be6);display:flex;align-items:center;justify-content:center;font-weight:700}
    .name{font-weight:700;font-size:15px}
    .device{color:var(--muted);font-size:13px}
    .card-foot{display:flex;align-items:center;justify-content:space-between;margin-top:10px}
    .small{font-size:13px;color:var(--muted)}
    .status-pill{padding:6px 10px;border-radius:999px;font-weight:700;font-size:12px}
    .status-locked{background:rgba(255,82,82,0.12);color:var(--danger);border:1px solid rgba(255,82,82,0.16)}
    .status-unlocked{background:rgba(0,230,118,0.07);color:var(--success);border:1px solid rgba(0,230,118,0.12)}

    footer{margin-top:22px;color:var(--muted);font-size:13px}

    /* small helper for inline buttons inside sweetalert content */
    .sw-row{display:flex;justify-content:space-between;gap:12px;padding:6px 0;border-bottom:1px dashed rgba(255,255,255,0.03)}
    .label{color:var(--muted);font-size:13px}
    .val{font-weight:700}
    .link-like{background:transparent;border:none;color:var(--accent);cursor:pointer;font-weight:700;padding:0}
  </style>
</head>
<body>
  <div class="container">
    <div class="header">
      <div class="brand">
        <div class="logo">ED</div>
        <div class="brand-text">
          <div class="title">EMI Dealer — Customer List</div>
          <div class="subtitle">Realtime Firebase viewer • Click card for details • Lock/Unlock (SweetAlert2)</div>
        </div>
      </div>

      <div class="controls">
        <input id="search" class="search" placeholder="Search name, number or device..." />
        <select id="filterLock" class="select">
          <option value="all">All lock status</option>
          <option value="unlocked">Unlocked</option>
          <option value="locked">Locked</option>
        </select>
        <button id="exportCsv" class="btn">Export CSV</button>
      </div>
    </div>

    <div class="meta-row"><div id="count">0 customers</div><div style="color:var(--muted)">Pins are masked — reveal only as needed</div></div>

    <div id="list" class="grid"></div>

    <footer>Replace firebaseConfig with your project's config. Secure DB rules before public use.</footer>
  </div>

  <!-- SweetAlert2 JS -->
  <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11/dist/sweetalert2.all.min.js"></script>

  <script type="module">
    import { initializeApp } from 'https://www.gstatic.com/firebasejs/9.23.0/firebase-app.js';
    import { getDatabase, ref, onValue, update } from 'https://www.gstatic.com/firebasejs/9.23.0/firebase-database.js';

    // init firebase
    const app = initializeApp(window.firebaseConfig);
    const db = getDatabase(app);
    const rootRef = ref(db, 'EMI_All_Users');

    // ui refs
    const listEl = document.getElementById('list');
    const searchEl = document.getElementById('search');
    const filterLock = document.getElementById('filterLock');
    const exportCsv = document.getElementById('exportCsv');
    const countEl = document.getElementById('count');

    let rawData = {};

    // utilities
    function esc(s){ return String(s||'').replace(/[&<>\"']/g, c => ({'&':'&amp;','<':'&lt;','>':'&gt;','\"':'&quot;',\"'\":\"&#39;\"})[c]); }
    function mask(v, keep=3){ if(!v) return '—'; v = String(v); if(v.length <= keep) return v; return v.slice(0,keep) + '•'.repeat(Math.max(0, v.length - keep)); }

    // builder
    function buildCard(uid, u) {
      const div = document.createElement('div');
      div.className = 'card';
      const initials = (u.name || '–').split(' ').map(x => x[0]||'').slice(0,2).join('').toUpperCase();
      div.innerHTML = `
        <div class="card-head">
          <div class="avatar">${esc(initials)}</div>
          <div>
            <div class="name">${esc(u.name || '—')}</div>
            <div class="device">${esc(u.device || '—')}</div>
          </div>
        </div>
        <div class="card-foot">
          <div class="small">IMEI: ${esc(u.IMEI1 || '—')}</div>
          <div><span class="status-pill ${u.lock_status === 'locked' ? 'status-locked' : 'status-unlocked'}">${esc(u.lock_status || '—')}</span></div>
        </div>
      `;
      // click shows SweetAlert2 detail popup
      div.addEventListener('click', () => openDetailPopup(uid));
      return div;
    }

    // main render
    function renderList(data) {
      rawData = data || {};
      const keys = Object.keys(rawData);
      countEl.textContent = `${keys.length} customers`;

      const q = (searchEl.value || '').trim().toLowerCase();
      const lfilter = filterLock.value;

      listEl.innerHTML = '';
      keys.forEach(uid => {
        const u = rawData[uid];
        if(!u) return;
        if(lfilter !== 'all' && (String(u.lock_status || '').toLowerCase() !== lfilter.toLowerCase())) return;
        const hay = [u.name,u.number,u.device,u.uid,u.email].map(x => String(x||'').toLowerCase()).join(' ');
        if(q && !hay.includes(q)) return;
        listEl.appendChild(buildCard(uid, u));
      });

      if(!listEl.children.length) {
        listEl.innerHTML = `<div style="grid-column:1/-1" class="card"><div style="font-weight:700">No customers found</div><div style="color:var(--muted);margin-top:8px">Try searching or remove filters</div></div>`;
      }
    }

    // open detail using SweetAlert2
    function openDetailPopup(uid) {
      const u = rawData[uid];
      if(!u) return;

      // prepare HTML content (escape)
      const html = `
        <div style="display:flex;gap:18px;flex-wrap:wrap">
          <div style="min-width:220px;max-width:260px;background:linear-gradient(180deg,var(--primary),#2b3be6);padding:14px;border-radius:10px;color:#fff">
            <div style="font-weight:800;font-size:16px">${esc(u.name||'—')}</div>
            <div style="color:var(--muted);margin-top:6px">${esc(u.device||'—')}</div>
            <div style="margin-top:10px;color:var(--muted)">Dealer: ${esc(u.dealer_code||'—')}</div>
            <div style="margin-top:10px"><span class="${u.lock_status==='locked'?'status-locked':'status-unlocked'}" style="padding:6px 10px;border-radius:999px;font-weight:700">${esc(u.lock_status||'—')}</span></div>
          </div>

          <div style="flex:1;min-width:280px">
            <div class="sw-row"><div class="label">UID</div><div class="val">${esc(u.uid||'—')}</div></div>
            <div class="sw-row"><div class="label">Number</div><div class="val">${esc(u.number||'—')}</div></div>
            <div class="sw-row"><div class="label">Email</div><div class="val">${esc(u.email||'—')}</div></div>
            <div class="sw-row"><div class="label">Device ID</div><div class="val">${esc(u.device_id||'—')}</div></div>
            <div class="sw-row"><div class="label">IMEI 1</div><div class="val">${esc(u.IMEI1||'—')}</div></div>
            <div class="sw-row"><div class="label">IMEI 2</div><div class="val">${esc(u.IMEI2||'—')}</div></div>
            <div class="sw-row"><div class="label">Status</div><div class="val">${esc(u.status||'—')}</div></div>
            <div class="sw-row" style="border-bottom:none"><div class="label">Unlock PIN</div>
              <div class="val">
                <span id="pinVal">${esc(mask(u.unlock_pin||''))}</span>
                <div style="display:inline-flex;gap:8px;margin-left:8px">
                  <button id="revealPinBtn" class="link-like">Show</button>
                  <button id="copyPinBtn" class="link-like">Copy</button>
                </div>
              </div>
            </div>
          </div>
        </div>
      `;

      Swal.fire({
        title: `${u.name || 'Customer'} — Details`,
        html: html,
        width: 860,
        showCloseButton: true,
        showCancelButton: false,
        showConfirmButton: false,
        didOpen: () => {
          // attach reveal & copy handlers
          const revealBtn = Swal.getPopup().querySelector('#revealPinBtn');
          const copyBtn = Swal.getPopup().querySelector('#copyPinBtn');
          const pinVal = Swal.getPopup().querySelector('#pinVal');

          if(revealBtn){
            revealBtn.addEventListener('click', () => {
              if(revealBtn.textContent === 'Show'){
                pinVal.textContent = esc(u.unlock_pin || '—');
                revealBtn.textContent = 'Hide';
              } else {
                pinVal.textContent = esc(mask(u.unlock_pin||'', 3));
                revealBtn.textContent = 'Show';
              }
            });
          }
          if(copyBtn){
            copyBtn.addEventListener('click', () => {
              navigator.clipboard.writeText(u.unlock_pin || '').then(() => {
                Swal.showToast({icon: 'success', title: 'PIN copied'}); // small helper, fallback below
                // we also show small toast
                Swal.fire({toast:true,position:'top-end',timer:900,showConfirmButton:false,title:'PIN copied',icon:'success'});
              }).catch(()=> {
                Swal.fire({toast:true,position:'top-end',timer:900,showConfirmButton:false,title:'Copy failed',icon:'error'});
              });
            });
          }

          // add custom action buttons below content
          const popup = Swal.getPopup();
          // create action area
          const actionBar = document.createElement('div');
          actionBar.style.display = 'flex';
          actionBar.style.justifyContent = 'flex-end';
          actionBar.style.gap = '10px';
          actionBar.style.marginTop = '14px';

          // Close button
          const closeBtn = document.createElement('button');
          closeBtn.textContent = 'Close';
          closeBtn.className = 'swal2-confirm btn';
          closeBtn.style.background = 'transparent';
          closeBtn.style.border = '1px solid rgba(255,255,255,0.06)';
          closeBtn.style.color = 'var(--muted)';
          closeBtn.style.padding = '10px 14px';
          closeBtn.style.borderRadius = '10px';
          closeBtn.addEventListener('click', () => Swal.close());

          // Lock / Unlock buttons
          const lockBtn = document.createElement('button');
          lockBtn.textContent = 'Lock';
          lockBtn.className = 'swal2-confirm btn';
          lockBtn.style.background = 'var(--danger)';
          lockBtn.style.color = '#fff';
          lockBtn.style.padding = '10px 14px';
          lockBtn.style.borderRadius = '10px';
          lockBtn.addEventListener('click', () => handleLockAction(uid, 'locked'));

          const unlockBtn = document.createElement('button');
          unlockBtn.textContent = 'Unlock';
          unlockBtn.className = 'swal2-confirm btn';
          unlockBtn.style.background = 'var(--success)';
          unlockBtn.style.color = '#021022';
          unlockBtn.style.padding = '10px 14px';
          unlockBtn.style.borderRadius = '10px';
          unlockBtn.addEventListener('click', () => handleLockAction(uid, 'unlocked'));

          // show only the appropriate action (don't show both active)
          if(u.lock_status === 'locked'){
            actionBar.appendChild(closeBtn);
            actionBar.appendChild(unlockBtn);
          } else {
            actionBar.appendChild(closeBtn);
            actionBar.appendChild(lockBtn);
          }

          // append actionBar to popup content
          popup.appendChild(actionBar);
        }
      });
    }

    // show confirm then update firebase
    function handleLockAction(uid, targetStatus){
      const user = rawData[uid];
      if(!user) return;

      Swal.fire({
        title: `${targetStatus === 'locked' ? 'Lock' : 'Unlock'} device?`,
        text: `Are you sure you want to ${targetStatus} the device for ${user.name || 'this customer'}?`,
        icon: 'question',
        showCancelButton: true,
        confirmButtonText: targetStatus === 'locked' ? 'Yes, lock' : 'Yes, unlock',
        customClass: { popup: 'swal2-popup' },
        reverseButtons: true
      }).then(result => {
        if(result.isConfirmed){
          // perform firebase update
          update(ref(db, 'EMI_All_Users/' + uid), { lock_status: targetStatus })
            .then(() => {
              Swal.fire({icon: 'success', title: `Device ${targetStatus}`, timer: 1200, showConfirmButton: false});
            })
            .catch(err => {
              Swal.fire({icon: 'error', title: 'Update failed', text: err.message || String(err)});
            });
        }
      });
    }

    // small helper to show toast (SweetAlert2 already)
    Swal.showToast = function(opts = {}) {
      Swal.fire(Object.assign({
        toast: true,
        position: 'top-end',
        showConfirmButton: false,
        timer: 1100
      }, opts));
    };

    // CSV export
    exportCsv.addEventListener('click', () => {
      const rows = [['uid','name','number','email','dealer_code','device','device_id','imei1','imei2','status','lock_status','unlock_pin']];
      Object.keys(rawData || {}).forEach(uid => {
        const u = rawData[uid] || {};
        rows.push([uid, u.name||'', u.number||'', u.email||'', u.dealer_code||'', u.device||'', u.device_id||'', u.IMEI1||'', u.IMEI2||'', u.status||'', u.lock_status||'', u.unlock_pin||'']);
      });
      const csv = rows.map(r => r.map(c => `"${String(c||'').replace(/"/g,'""')}"`).join(',')).join('\n');
      const blob = new Blob([csv], { type: 'text/csv' });
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a');
      a.href = url;
      a.download = 'emi_customers.csv';
      a.click();
      URL.revokeObjectURL(url);
    });

    // realtime listener
    onValue(rootRef, snapshot => {
      const val = snapshot.val() || {};
      renderList(val);
    }, err => {
      listEl.innerHTML = `<div style="grid-column:1/-1" class="card"><div style="font-weight:700">Failed to read data</div><div style="color:var(--muted);margin-top:8px">${esc(err.message||err)}</div></div>`;
    });

    // wire filters
    [searchEl, filterLock].forEach(el => el.addEventListener('input', () => renderList(rawData)));
  </script>
</body>
</html>
